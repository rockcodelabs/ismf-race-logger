#!/bin/bash

# ISMF Race Logger - Docker Development Script
# Usage: bin/docker-dev [command]
#
# Commands:
#   setup    - Build containers and setup database
#   start    - Start all containers
#   stop     - Stop all containers
#   restart  - Restart all containers
#   logs     - Show logs from all containers
#   console  - Open Rails console
#   bash     - Open bash shell in app container
#   db:reset - Reset the database
#   test     - Run the test suite
#   bundle   - Run bundle install
#   migrate  - Run database migrations
#   seed     - Seed the database

set -e

COMPOSE_FILE="docker-compose.yml"

case "${1:-start}" in
  setup)
    echo "ğŸš€ Setting up ISMF Race Logger development environment..."
    docker compose -f $COMPOSE_FILE build
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:create
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:migrate
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:seed
    echo "âœ… Setup complete! Run 'bin/docker-dev start' to start the app."
    ;;
  start)
    echo "ğŸš€ Starting ISMF Race Logger..."
    docker compose -f $COMPOSE_FILE up
    ;;
  stop)
    echo "ğŸ›‘ Stopping ISMF Race Logger..."
    docker compose -f $COMPOSE_FILE down
    ;;
  restart)
    echo "ğŸ”„ Restarting ISMF Race Logger..."
    docker compose -f $COMPOSE_FILE down
    docker compose -f $COMPOSE_FILE up
    ;;
  logs)
    docker compose -f $COMPOSE_FILE logs -f
    ;;
  console)
    docker compose -f $COMPOSE_FILE exec app bin/rails console
    ;;
  bash)
    docker compose -f $COMPOSE_FILE exec app bash
    ;;
  db:reset)
    echo "ğŸ—‘ï¸  Resetting database..."
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:drop db:create db:migrate db:seed
    echo "âœ… Database reset complete!"
    ;;
  test)
    echo "ğŸ§ª Running tests..."
    docker compose -f $COMPOSE_FILE run --rm -e RAILS_ENV=test app bin/rails db:test:prepare
    docker compose -f $COMPOSE_FILE run --rm -e RAILS_ENV=test app bundle exec rspec
    ;;
  bundle)
    echo "ğŸ“¦ Running bundle install..."
    docker compose -f $COMPOSE_FILE run --rm app bundle install
    ;;
  migrate)
    echo "ğŸ”„ Running migrations..."
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:migrate
    ;;
  seed)
    echo "ğŸŒ± Seeding database..."
    docker compose -f $COMPOSE_FILE run --rm app bin/rails db:seed
    ;;
  *)
    echo "ISMF Race Logger - Docker Development Commands"
    echo ""
    echo "Usage: bin/docker-dev [command]"
    echo ""
    echo "Commands:"
    echo "  setup    - Build containers and setup database"
    echo "  start    - Start all containers (default)"
    echo "  stop     - Stop all containers"
    echo "  restart  - Restart all containers"
    echo "  logs     - Show logs from all containers"
    echo "  console  - Open Rails console"
    echo "  bash     - Open bash shell in app container"
    echo "  db:reset - Reset the database"
    echo "  test     - Run the test suite"
    echo "  bundle   - Run bundle install"
    echo "  migrate  - Run database migrations"
    echo "  seed     - Seed the database"
    ;;
esac