#!/usr/bin/env bash
# frozen_string_literal: true

# Touch Screen Implementation - Quick Test Runner
# 
# This script runs automated tests and displays console output
# for quick verification of touch screen functionality.
#
# Usage:
#   ./bin/test-touch              # Run all tests
#   ./bin/test-touch --verbose    # Run with detailed output
#   ./bin/test-touch --browser    # Open browser after tests

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
VERBOSE=false
OPEN_BROWSER=false

# Parse arguments
for arg in "$@"; do
  case $arg in
    --verbose|-v)
      VERBOSE=true
      shift
      ;;
    --browser|-b)
      OPEN_BROWSER=true
      shift
      ;;
    --help|-h)
      echo "Usage: ./bin/test-touch [options]"
      echo ""
      echo "Options:"
      echo "  --verbose, -v    Show detailed test output"
      echo "  --browser, -b    Open browser in touch mode after tests"
      echo "  --help, -h       Show this help message"
      exit 0
      ;;
  esac
done

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Touch Screen Implementation Tests${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo -e "${RED}✗ Docker is not running${NC}"
  echo "  Please start Docker Desktop and try again"
  exit 1
fi

echo -e "${GREEN}✓ Docker is running${NC}"

# Check if containers are up
if ! docker compose ps | grep -q "Up"; then
  echo -e "${YELLOW}⚠ Containers are not running, starting...${NC}"
  docker compose up -d
  echo -e "${GREEN}✓ Containers started${NC}"
else
  echo -e "${GREEN}✓ Containers are up${NC}"
fi

echo ""
echo -e "${BLUE}Running RSpec system tests...${NC}"
echo ""

# Run RSpec tests
if [ "$VERBOSE" = true ]; then
  docker compose exec -T -e RAILS_ENV=test app bundle exec rspec spec/system/touch_display_spec.rb --format documentation
else
  docker compose exec -T -e RAILS_ENV=test app bundle exec rspec spec/system/touch_display_spec.rb --format progress
fi

TEST_EXIT_CODE=$?

echo ""
echo -e "${BLUE}========================================${NC}"

if [ $TEST_EXIT_CODE -eq 0 ]; then
  echo -e "${GREEN}✓ All tests passed!${NC}"
  echo ""
  
  # Show manual testing instructions
  echo -e "${BLUE}Manual Testing:${NC}"
  echo ""
  echo -e "  ${YELLOW}Mac (Development):${NC}"
  echo "    http://localhost:3005?touch=1"
  echo ""
  echo -e "  ${YELLOW}Raspberry Pi (Production):${NC}"
  echo "    ssh pi@pi5main.local"
  echo "    sudo systemctl status chromium-kiosk"
  echo ""
  echo -e "  ${YELLOW}View Logs:${NC}"
  echo "    docker compose logs -f app"
  echo ""
  echo -e "  ${YELLOW}Test Checklist:${NC}"
  echo "    docs/TOUCH_TESTING_CHECKLIST.md"
  echo ""
  
  # Open browser if requested
  if [ "$OPEN_BROWSER" = true ]; then
    echo -e "${BLUE}Opening browser in touch mode...${NC}"
    if [[ "$OSTYPE" == "darwin"* ]]; then
      open "http://localhost:3005?touch=1"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
      xdg-open "http://localhost:3005?touch=1"
    fi
  fi
else
  echo -e "${RED}✗ Some tests failed${NC}"
  echo ""
  echo "Run with --verbose flag for detailed output:"
  echo "  ./bin/test-touch --verbose"
  exit 1
fi

echo -e "${BLUE}========================================${NC}"