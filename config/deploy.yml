# Name of your application
service: ismf-race-logger

# Name of the container image
image: regedarek/ismf-race-logger

# Deploy to these servers
servers:
  web:
    hosts:
      - pi5main.local

# Docker registry configuration
registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Retain last 3 container versions
retain_containers: 3

# Deployment timeout
deploy_timeout: 120

# Proxy configuration (kamal-proxy)
proxy:
  ssl: false
  host: ismf.taterniczek.pl
  app_port: 3005
  healthcheck:
    path: /up
    interval: 2
    timeout: 5

# Environment variables
env:
  clear:
    RAILS_ENV: production
    SOLID_QUEUE_IN_PUMA: true
    PORT: 3005
    DB_HOST: ismf-race-logger-postgres
    POSTGRES_USER: ismf_production
    POSTGRES_DB: ismf_race_logger_production
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD

# SSH configuration
ssh:
  user: rege

# Persistent storage volume
volumes:
  - "ismf_race_logger_storage:/rails/storage"

# Builder configuration
builder:
  arch: arm64

# Aliases
# Accessories (PostgreSQL)
accessories:
  postgres:
    service: ismf-race-logger-postgres
    image: postgres:16.0
    host: pi5main.local
    port: "5434:5432"
    env:
      clear:
        POSTGRES_USER: ismf_production
        POSTGRES_DB: ismf_race_logger_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data-production:/var/lib/postgresql/data

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"
