name: Deploy to Production
concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    # Uses organization runner: pi5main-org (ARM64)
    # Runs directly on Pi server, deploying to localhost
    runs-on: [self-hosted, Linux, ARM64]
    timeout-minutes: 20
    env:
      DOCKER_BUILDKIT: 1

    steps:
      - uses: actions/checkout@v4

      # Install Bitwarden Secrets Manager CLI
      - name: Install Bitwarden Secrets Manager CLI
        run: |
          if ! command -v bws &> /dev/null; then
            echo "Installing Bitwarden Secrets Manager CLI v1.0.0..."
            
            curl -L -o bws-aarch64-unknown-linux-gnu.zip \
              "https://github.com/bitwarden/sdk-sm/releases/download/bws-v1.0.0/bws-aarch64-unknown-linux-gnu-1.0.0.zip"
            
            unzip -o bws-aarch64-unknown-linux-gnu.zip
            chmod +x bws
            sudo mv bws /usr/local/bin/
            rm bws-aarch64-unknown-linux-gnu.zip
          else
            echo "✅ Bitwarden Secrets Manager CLI already installed"
          fi
          
          bws --version

      # Fetch secrets from Bitwarden Secrets Manager
      - name: Get Secrets from Bitwarden
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BW_ACCESS_TOKEN }}
        run: |
          echo "Fetching secrets from Bitwarden Secrets Manager..."
          
          # Fetch each secret by ID
          KAMAL_REGISTRY_USERNAME=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_USERNAME }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          KAMAL_REGISTRY_PASSWORD=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_PASSWORD }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          RAILS_MASTER_KEY=$(bws secret get ${{ secrets.BW_SECRET_ISMF_MASTER_KEY }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          
          # Save to GITHUB_ENV for subsequent steps
          echo "KAMAL_REGISTRY_USERNAME=$KAMAL_REGISTRY_USERNAME" >> $GITHUB_ENV
          echo "KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD" >> $GITHUB_ENV
          echo "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" >> $GITHUB_ENV
          
          # Create .kamal/secrets file for Kamal to read
          mkdir -p .kamal
          echo "KAMAL_REGISTRY_USERNAME=$KAMAL_REGISTRY_USERNAME" > .kamal/secrets
          echo "KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD" >> .kamal/secrets
          echo "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" >> .kamal/secrets
          
          # Verify secrets are set (without exposing values)
          [[ -n "$KAMAL_REGISTRY_USERNAME" ]] && echo "✅ KAMAL_REGISTRY_USERNAME fetched" || { echo "❌ KAMAL_REGISTRY_USERNAME missing"; exit 1; }
          [[ -n "$KAMAL_REGISTRY_PASSWORD" ]] && echo "✅ KAMAL_REGISTRY_PASSWORD fetched" || { echo "❌ KAMAL_REGISTRY_PASSWORD missing"; exit 1; }
          [[ -n "$RAILS_MASTER_KEY" ]] && echo "✅ RAILS_MASTER_KEY fetched (length: ${#RAILS_MASTER_KEY})" || { echo "❌ RAILS_MASTER_KEY missing"; exit 1; }
          
          echo ""
          echo "✅ All secrets fetched successfully and written to .kamal/secrets!"

      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          else
            echo "✅ jq already installed"
          fi

      - name: Check and install Ruby if needed
        run: |
          # Check if Ruby version is >= 3.0
          if command -v ruby &> /dev/null; then
            RUBY_VERSION=$(ruby -e 'puts RUBY_VERSION')
            RUBY_MAJOR=$(echo $RUBY_VERSION | cut -d. -f1)
            echo "Current Ruby version: $RUBY_VERSION"
            
            if [ "$RUBY_MAJOR" -ge 3 ]; then
              echo "✅ Ruby $RUBY_VERSION is compatible"
              exit 0
            else
              echo "⚠️  Ruby $RUBY_VERSION is too old, need >= 3.0"
            fi
          fi
          
          # Install ruby-install and chruby
          echo "Installing ruby-install and chruby..."
          cd /tmp
          
          # Install ruby-install
          wget -O ruby-install-0.9.3.tar.gz https://github.com/postmodern/ruby-install/releases/download/v0.9.3/ruby-install-0.9.3.tar.gz
          tar -xzvf ruby-install-0.9.3.tar.gz
          cd ruby-install-0.9.3/
          sudo make install
          
          # Install chruby
          cd /tmp
          wget -O chruby-0.3.9.tar.gz https://github.com/postmodern/chruby/archive/v0.3.9.tar.gz
          tar -xzvf chruby-0.3.9.tar.gz
          cd chruby-0.3.9/
          sudo make install
          
          # Install Ruby 3.3.0
          echo "Installing Ruby 3.3.0..."
          sudo ruby-install ruby 3.3.0
          
          # Setup chruby for this session
          source /usr/local/share/chruby/chruby.sh
          chruby ruby-3.3.0
          
          ruby -v

      - name: Setup Ruby gem paths
        run: |
          # Load chruby if installed
          if [ -f /usr/local/share/chruby/chruby.sh ]; then
            source /usr/local/share/chruby/chruby.sh
            chruby ruby-3.3.0 || true
          fi
          
          echo "GEM_HOME=$(ruby -r rubygems -e 'puts Gem.user_dir')" >> $GITHUB_ENV
          echo "$(ruby -r rubygems -e 'puts Gem.user_dir')/bin" >> $GITHUB_PATH

      - name: Install Kamal
        run: |
          # Load chruby if installed
          if [ -f /usr/local/share/chruby/chruby.sh ]; then
            source /usr/local/share/chruby/chruby.sh
            chruby ruby-3.3.0 || true
          fi
          
          if ! command -v kamal &> /dev/null; then
            gem install kamal --no-document
          fi
          kamal version

      - name: Login to Docker Hub
        run: |
          echo "$KAMAL_REGISTRY_PASSWORD" | docker login -u "$KAMAL_REGISTRY_USERNAME" --password-stdin

      - name: Release deploy lock
        run: kamal lock release || true

      - name: Deploy locally
        run: |
          # Load chruby if installed
          if [ -f /usr/local/share/chruby/chruby.sh ]; then
            source /usr/local/share/chruby/chruby.sh
            chruby ruby-3.3.0 || true
          fi
          
          # Deploy to localhost since runner IS the deployment server
          kamal deploy --skip-push

      - name: Cleanup old Docker images
        run: kamal prune all || true
        continue-on-error: true
