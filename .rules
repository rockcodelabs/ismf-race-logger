# ISMF Race Logger — AI Rules

You are an AI coding agent operating inside the ISMF Race Logger project.
You MUST follow these rules at all times.

---

## 1. Scope and Authority

These rules define:
- architectural constraints
- workflow discipline
- naming conventions
- testing and quality requirements

You MUST NOT:
- invent alternative architectures
- bypass documented workflows
- inline large code templates unless explicitly requested
- execute commands without proper environment flags
- create multiple documentation files, keep them organized and essential

Procedural details, commands, and examples live in documentation files.
You MUST reference them, not duplicate them.

---

## 2. Architecture (MANDATORY)

This project uses a **Hanami-hybrid architecture on Rails 8.1 + dry-rb**.

You MUST respect the following layering:

```
Request → Controller → Operation → Repo → Database
               ↓           ↓
         Broadcaster    Struct
               ↓           ↓
             Part     ← Factory
               ↓
           Template
```

### Layer Responsibilities

| Layer | Location | Responsibility |
|-------|----------|----------------|
| Models | `app/models/` | Thin ActiveRecord (associations only) |
| Structs | `app/db/structs/` | Immutable domain objects |
| Repos | `app/db/repos/` | Data access (returns structs) |
| Operations | `app/operations/` | Business logic (dry-monads) |
| Contracts | `app/operations/contracts/` | Input validation |
| Controllers | `app/web/controllers/` | Thin HTTP adapters |
| Parts | `app/web/parts/` | Presentation decorators |
| Broadcasters | `app/broadcasters/` | Real-time Turbo Streams |

Full architecture details are defined in: `docs/ARCHITECTURE.md`

You MUST follow it exactly.

---

## 3. Data Modeling Rules

- All domain data returned from repos MUST be wrapped in structs
- Use `dry-struct` for full entities (single record)
- Use Ruby `Data.define` for summaries (collections)
- ActiveRecord models MUST NOT contain business logic
- Presentation logic MUST only exist in Parts

### Where Things Belong (Hanami Style)

| Concern | Location | NOT in Model |
|---------|----------|--------------|
| **Validations** | `app/operations/contracts/` | ❌ No `validates` in models |
| **Scopes/Queries** | `app/db/repos/` as methods | ❌ No `scope` in models |
| **Enums** | `lib/types.rb` as `Types::Enum` | ❌ No `enum` in models |
| **Callbacks** | `app/operations/` | ❌ No `before_*`/`after_*` in models |
| **Business logic** | `app/operations/` | ❌ No methods in models |
| **Presentation** | `app/web/parts/` | ❌ No display methods in models |

### Anti-Patterns (NEVER DO THIS)

```ruby
# ❌ WRONG - Traditional Rails in model
class Incident < ApplicationRecord
  enum :status, { unofficial: 0, official: 1 }
  validates :race, presence: true
  scope :pending, -> { where(status: :pending) }
  before_save :normalize_data
  def officialize!(user); end
end

# ✅ CORRECT - Hanami-hybrid pattern
class Incident < ApplicationRecord
  belongs_to :race
  has_many :reports
  # NOTHING ELSE - associations only
end
```

Database design with full schema is in: `docs/DATABASE_DESIGN.md`

---

## 4. Naming Conventions (STRICT)

You MUST follow these conventions:

| Component | Pattern | Example |
|-----------|---------|---------|
| Model | `User` | `app/models/user.rb` |
| Struct | `Structs::User` | `app/db/structs/user.rb` |
| Summary | `Structs::UserSummary` | `app/db/structs/user_summary.rb` |
| Repo | `UserRepo` | `app/db/repos/user_repo.rb` |
| Operation | `Operations::Users::Create` | `app/operations/users/create.rb` |
| Contract | `Operations::Contracts::CreateUser` | `app/operations/contracts/create_user.rb` |
| Controller | `Admin::UsersController` | `app/web/controllers/admin/users_controller.rb` |
| Part | `Web::Parts::User` | `app/web/parts/user.rb` |
| Broadcaster | `UserBroadcaster` | `app/broadcasters/user_broadcaster.rb` |

File paths MUST mirror namespaces.

---

## 5. Mandatory Agents (NON-NEGOTIABLE)

You MUST use the designated agent for each task type. Do NOT execute commands directly.

| Task Type | Agent | Mandatory When |
|-----------|-------|----------------|
| **Feature development** | `@feature` | User mentions "@feature" or requests new CRUD |
| **Running tests** | `@test` | Running RSpec tests in any environment |
| **Console/Runner** | `@console` | Executing Ruby code in Rails context (dev/test/prod) |
| **API testing** | `@curl` | Testing HTTP endpoints with curl |
| **Quality checks** | `@quality` | Running RuboCop or Packwerk |
| **Troubleshooting** | `@debug` | Container issues, server won't start, connection errors |
| **Migrations** | `@migration` | Generating database migrations |

### Agent Usage Rules

1. **ALWAYS** check `AGENTS.md` for agent-specific instructions before executing
2. **NEVER** bypass agents by running commands directly for these task types
3. **If an agent doesn't exist** for your task, execute commands per `docs/DEV_COMMANDS.md`
4. **Agent definitions are authoritative** - they know environment-specific patterns

Example violations:
- ❌ Running `docker compose exec -T app bundle exec rspec` directly (use `@test`)
- ❌ Running `docker compose exec app bin/rails console` directly (use `@console`)
- ❌ Running `curl` commands directly (use `@curl`)

All agent definitions are in: `AGENTS.md`

---

## 6. Docker & Environment Conventions (MANDATORY)

This project runs in Docker. You MUST follow these rules:

- The main service is named `app` (NOT `web`)
- Always use `./bin/rails` (NOT just `rails`)
- Add `-T` flag for non-interactive commands (runner, seeds, migrations)
- Refer to `@console` agent for environment-specific console/runner usage

### Ruby Environment Setup (CRITICAL)

**ALL Docker and Kamal commands require proper Ruby environment setup:**

This project requires Ruby 3.4.8 (see `.ruby-version`). System Ruby cannot parse modern Gemfile syntax.

**When executing Docker or Kamal commands, you MUST:**
1. Source `~/.zshrc` to load shell environment
2. Use `chruby ruby-3.4.8` to activate correct Ruby version
3. Run bundle install if needed (gems missing)

**Wrapper pattern:**
```bash
zsh -c 'source ~/.zshrc && chruby ruby-3.4.8 && YOUR_COMMAND_HERE'
```

Command examples in `AGENTS.md` show logical commands. They assume proper Ruby environment is active.

All procedural commands are documented in: `docs/DEV_COMMANDS.md`

---

## 7. Production & Kamal Deployment (MANDATORY)

This project uses **Kamal** for deployment to production (host: `pi5main.local`).

**Critical Rules:**
1. If you just fixed code (e.g., Zeitwerk), you MUST deploy before accessing production
2. Container names change on each deploy - Kamal handles this with `--reuse` flag
3. Use the `@console` agent for running commands across all environments (dev/test/prod)

All Kamal commands are documented in: `docs/DEV_COMMANDS.md`

---

## 8. Dependency Injection

---

This project uses **Kamal** for deployment to production (host: `pi5main.local`).

**Critical Rules:**
1. If you just fixed code (e.g., Zeitwerk), you MUST deploy before accessing production
2. Container names change on each deploy - Kamal handles this with `--reuse` flag
3. Use the `@console` agent for running commands across all environments (dev/test/prod)
4. ALL Kamal commands MUST use the Ruby environment setup from section 6

All Kamal commands are documented in: `docs/DEV_COMMANDS.md`

---

## 8. Dependency Injection

- Repos, parts factories, and broadcasters MUST be resolved via `AppContainer`
- No hard-coded class instantiation for repos or parts in controllers
- Container keys follow pattern: `repos.user`, `parts.factory`, `broadcasters.incident`

---

## 9. Feature Development Workflow

When the user mentions `@feature` or requests a new feature:

You MUST follow the workflow defined in: `docs/FEATURE_WORKFLOW.md`

You MUST:
1. Ask questions ONE BY ONE (wait for answer)
2. Propose a solution before implementing
3. Wait for explicit approval before writing code
4. Write and run tests before declaring completion

You MUST NOT skip phases.

---

## 10. Testing Discipline (NON-NEGOTIABLE)

- All features MUST include tests
- Tests MUST be written before declaring completion
- Tests MUST be executed using `@test` agent (handles RAILS_ENV=test automatically)
- All test failures MUST be fixed before completion

Exact commands are defined in: `docs/DEV_COMMANDS.md`

---

## 11. Code Quality Gates

Before completing any task, you MUST ensure:
- RuboCop passes (use `@quality` agent)
- Packwerk boundaries are respected (use `@quality` agent)
- Frozen string literals are present
- Documentation exists for repos, operations, lib code

Quality procedures are defined in: `docs/DEV_COMMANDS.md`

---

## 12. Code Templates

When generating new components, use templates from: `templates/`

Available templates:
- `struct_full.rb` — dry-struct for single records
- `struct_summary.rb` — Ruby Data for collections
- `repo.rb` — Repository pattern
- `operation.rb` — Business logic with dry-monads
- `contract.rb` — dry-validation contract
- `controller.rb` — Thin controller
- `part.rb` — Presentation decorator
- `broadcaster.rb` — Turbo Stream broadcaster

---

## 13. Output Expectations

- Prefer small, focused diffs
- Explain architectural decisions briefly
- Never generate speculative or placeholder code
- Ask for clarification when requirements are ambiguous
- Reference documentation instead of repeating it

---

## 14. Documentation References

| Document | Purpose |
|----------|---------|
| `docs/ARCHITECTURE.md` | Full architecture details |
| `docs/DATABASE_DESIGN.md` | Database schema and domain models |
| `docs/DEV_COMMANDS.md` | All shell commands |
| `docs/FEATURE_WORKFLOW.md` | @feature workflow phases |
| `AGENTS.md` | **MANDATORY agents and usage rules** |
| `templates/` | Code templates |

---

These rules override default AI behavior.