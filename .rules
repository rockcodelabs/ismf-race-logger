# ISMF Race Logger — AI Rules

You are an AI coding agent operating inside the ISMF Race Logger project.
You MUST follow these rules at all times.

---

## 1. Scope and Authority

These rules define:
- architectural constraints
- workflow discipline
- naming conventions
- testing and quality requirements

You MUST NOT:
- invent alternative architectures
- bypass documented workflows
- inline large code templates unless explicitly requested
- execute commands without proper environment flags
- create multiple documentation files, keep them organized and essential

Procedural details, commands, and examples live in documentation files.
You MUST reference them, not duplicate them.

---

## 2. Architecture (MANDATORY)

This project uses a **Hanami-hybrid architecture on Rails 8.1 + dry-rb**.

You MUST respect the following layering:

```
Request → Controller → Operation → Repo → Database
               ↓           ↓
         Broadcaster    Struct
               ↓           ↓
             Part     ← Factory
               ↓
           Template
```

### Layer Responsibilities

| Layer | Location | Responsibility |
|-------|----------|----------------|
| Models | `app/models/` | Thin ActiveRecord (associations only) |
| Structs | `app/db/structs/` | Immutable domain objects |
| Repos | `app/db/repos/` | Data access (returns structs) |
| Operations | `app/operations/` | Business logic (dry-monads) |
| Contracts | `app/operations/contracts/` | Input validation |
| Controllers | `app/web/controllers/` | Thin HTTP adapters |
| Parts | `app/web/parts/` | Presentation decorators |
| Broadcasters | `app/broadcasters/` | Real-time Turbo Streams |

Full architecture details are defined in: `docs/ARCHITECTURE.md`

You MUST follow it exactly.

---

## 3. Data Modeling Rules

- All domain data returned from repos MUST be wrapped in structs
- Use `dry-struct` for full entities (single record)
- Use Ruby `Data.define` for summaries (collections)
- ActiveRecord models MUST NOT contain business logic
- Presentation logic MUST only exist in Parts

### Where Things Belong (Hanami Style)

| Concern | Location | NOT in Model |
|---------|----------|--------------|
| **Validations** | `app/operations/contracts/` | ❌ No `validates` in models |
| **Scopes/Queries** | `app/db/repos/` as methods | ❌ No `scope` in models |
| **Enums** | `lib/types.rb` as `Types::Enum` | ❌ No `enum` in models |
| **Callbacks** | `app/operations/` | ❌ No `before_*`/`after_*` in models |
| **Business logic** | `app/operations/` | ❌ No methods in models |
| **Presentation** | `app/web/parts/` | ❌ No display methods in models |

### Anti-Patterns (NEVER DO THIS)

```ruby
# ❌ WRONG - Traditional Rails in model
class Incident < ApplicationRecord
  enum :status, { unofficial: 0, official: 1 }
  validates :race, presence: true
  scope :pending, -> { where(status: :pending) }
  before_save :normalize_data
  def officialize!(user); end
end

# ✅ CORRECT - Hanami-hybrid pattern
class Incident < ApplicationRecord
  belongs_to :race
  has_many :reports
  # NOTHING ELSE - associations only
end
```

Database design with full schema is in: `docs/DATABASE_DESIGN.md`

---

## 4. Naming Conventions (STRICT)

You MUST follow these conventions:

| Component | Pattern | Example |
|-----------|---------|---------|
| Model | `User` | `app/models/user.rb` |
| Struct | `Structs::User` | `app/db/structs/user.rb` |
| Summary | `Structs::UserSummary` | `app/db/structs/user_summary.rb` |
| Repo | `UserRepo` | `app/db/repos/user_repo.rb` |
| Operation | `Operations::Users::Create` | `app/operations/users/create.rb` |
| Contract | `Operations::Contracts::CreateUser` | `app/operations/contracts/create_user.rb` |
| Controller | `Admin::UsersController` | `app/web/controllers/admin/users_controller.rb` |
| Part | `Web::Parts::User` | `app/web/parts/user.rb` |
| Broadcaster | `UserBroadcaster` | `app/broadcasters/user_broadcaster.rb` |

File paths MUST mirror namespaces.

---

## 5. Mandatory Agents (NON-NEGOTIABLE)

You MUST use the designated agent for each task type. Do NOT execute commands directly.

| Task Type | Agent | Mandatory When |
|-----------|-------|----------------|
| **Feature development** | `@feature` | User mentions "@feature" or requests new CRUD |
| **Running tests** | `@test` | Running RSpec tests in any environment |
| **Console/Runner** | `@console` | Executing Ruby code in Rails context (dev/test/prod) |
| **API testing** | `@curl` | Testing HTTP endpoints with curl |
| **Quality checks** | `@quality` | Running RuboCop or Packwerk |
| **Troubleshooting** | `@debug` | Container issues, server won't start, connection errors |
| **Migrations** | `@migration` | Generating database migrations |
| **Deployment** | `@deploy` | Pushing code changes to production |

### Agent Usage Rules

1. **ALWAYS** check `AGENTS.md` for agent-specific instructions before executing
2. **NEVER** bypass agents by running commands directly for these task types
3. **If an agent doesn't exist** for your task, execute commands per `docs/DEV_COMMANDS.md`
4. **Agent definitions are authoritative** - they know environment-specific patterns

Example violations:
- ❌ Running `docker compose exec -T app bundle exec rspec` directly (use `@test`)
- ❌ Running `docker compose exec app bin/rails console` directly (use `@console`)
- ❌ Running `curl` commands directly (use `@curl`)

All agent definitions are in: `AGENTS.md`

---

## 6. Docker & Environment Conventions (MANDATORY)

This project runs in Docker. You MUST follow these rules:

- The main service is named `app` (NOT `web`)
- Always use `./bin/rails` (NOT just `rails`)
- Add `-T` flag for non-interactive commands (runner, seeds, migrations)
- Refer to `@console` agent for environment-specific console/runner usage

### Ruby Environment Setup (CRITICAL)

**ALL Docker and Kamal commands require proper Ruby environment setup:**

This project requires Ruby 3.4.8 (see `.ruby-version`). System Ruby cannot parse modern Gemfile syntax.

**When executing Docker or Kamal commands, you MUST:**
1. Source `~/.zshrc` to load shell environment
2. Use `chruby ruby-3.4.8` to activate correct Ruby version
3. Run bundle install if needed (gems missing)

**Wrapper pattern:**
```bash
zsh -c 'source ~/.zshrc && chruby ruby-3.4.8 && YOUR_COMMAND_HERE'
```

Command examples in `AGENTS.md` show logical commands. They assume proper Ruby environment is active.

All procedural commands are documented in: `docs/DEV_COMMANDS.md`

---

## 7. Production & Kamal Deployment (MANDATORY)

This project uses **Kamal** for deployment to production (host: `pi5main.local`).

**Deployment Workflow:**
- Deployment happens automatically via **GitHub Actions** on push to main branch
- After committing and pushing code changes, WAIT for GitHub Actions to complete (3-5 minutes)
- Manual `kamal deploy` requires secrets and is NOT the normal workflow
- Use the `@deploy` agent for deployment guidance

**Critical Rules:**
1. Code changes require push to GitHub and automated deployment via Actions
2. After pushing, WAIT for GitHub Actions deployment to complete before testing production
3. Container names change on each deploy - Kamal handles this with `--reuse` flag
4. Use the `@console` agent for running commands across all environments (dev/test/prod)
5. ALL Kamal commands MUST use the Ruby environment setup from section 6

All Kamal commands are documented in: `docs/DEV_COMMANDS.md`

---

## 8. Dependency Injection

- Repos, parts factories, and broadcasters MUST be resolved via `AppContainer`
- No hard-coded class instantiation for repos or parts in controllers
- Container keys follow pattern: `repos.user`, `parts.factory`, `broadcasters.incident`

---

## 9. Feature Development Workflow

When the user mentions `@feature` or requests a new feature:

You MUST follow the workflow defined in: `docs/FEATURE_WORKFLOW.md`

You MUST:
1. Ask questions ONE BY ONE (wait for answer)
2. Propose a solution before implementing
3. Wait for explicit approval before writing code
4. Write and run tests before declaring completion

You MUST NOT skip phases.

---

## 10. Testing Discipline (NON-NEGOTIABLE)

- All features MUST include tests
- Tests MUST be written before declaring completion
- Tests MUST be executed using `@test` agent (handles RAILS_ENV=test automatically)
- All test failures MUST be fixed before completion

Exact commands are defined in: `docs/DEV_COMMANDS.md`

---

## 11. Code Quality Gates

Before completing any task, you MUST ensure:
- RuboCop passes (use `@quality` agent)
- Packwerk boundaries are respected (use `@quality` agent)
- Frozen string literals are present
- Documentation exists for repos, operations, lib code

Quality procedures are defined in: `docs/DEV_COMMANDS.md`

---

## 12. Code Templates

When generating new components, use templates from: `templates/`

Available templates:
- `struct_full.rb` — dry-struct for single records
- `struct_summary.rb` — Ruby Data for collections
- `repo.rb` — Repository pattern
- `operation.rb` — Business logic with dry-monads
- `contract.rb` — dry-validation contract
- `controller.rb` — Thin controller
- `part.rb` — Presentation decorator
- `broadcaster.rb` — Turbo Stream broadcaster

---

## 13. Output Expectations

- Prefer small, focused diffs
- Explain architectural decisions briefly
- Never generate speculative or placeholder code
- Ask for clarification when requirements are ambiguous
- Reference documentation instead of repeating it

---

## 14. Documentation References

| Document | Purpose |
|----------|---------|
| `docs/ARCHITECTURE.md` | Full architecture details |
| `docs/DATABASE_DESIGN.md` | Database schema and domain models |
| `docs/DEV_COMMANDS.md` | All shell commands |
| `docs/FEATURE_WORKFLOW.md` | @feature workflow phases |
| `AGENTS.md` | **MANDATORY agents and usage rules** |
| `templates/` | Code templates |

---

## 15. Touch Display UI Requirements (MANDATORY)

This project includes a **7" touch display kiosk mode** (Raspberry Pi Touch Display 2, 800×480).

### Touch View Requirements

**All touch views MUST include:**
- ✅ **Persistent navigation bar** (fixed top, collapsible with hamburger menu)
- ✅ **Page title** (set via `content_for :page_title`)
- ✅ **Large touch targets** (minimum 64px for nav, 56px for content)
- ✅ **Clear navigation** (Home, Back, Sign Out always visible)
- ✅ **Touch-optimized spacing** (16-24px gaps between nav buttons)
- ✅ **Proper layout** (flexbox with justified content, no overlapping footer)
- ❌ **NO desktop toggle links** (users are already in touch mode)

### Touch View File Convention

Touch views use `.touch.html.erb` suffix:
- `app/views/home/index.touch.html.erb`
- `app/views/sessions/new.touch.html.erb`
- `app/views/admin/dashboard/index.touch.html.erb`
- Rails automatically selects `.touch` variant when `request.variant = :touch`

### Navigation Patterns

**Navigation is now automatic!** A persistent, collapsible navigation bar appears on all pages except home.

**Home Screen:**
```erb
<!-- No navigation bar on home (root page) -->
<!-- Use flexbox layout to prevent footer overlap -->
<div class="min-h-screen flex flex-col items-center justify-between py-8 px-6">
  <div class="flex-1 flex flex-col items-center justify-center w-full">
    <!-- Content here -->
  </div>
  <div class="w-full text-center pb-4">
    <!-- Footer here -->
  </div>
</div>
```

**All Other Pages:**
```erb
<!-- Set page title for navigation bar -->
<% content_for :page_title, "Your Page Title" %>

<div class="min-h-screen touch-spacing">
  <h1 class="text-4xl font-extrabold text-white mb-8 text-center">Your Page Title</h1>
  
  <!-- Your content here -->
  <!-- Navigation bar is automatic (Home, Back, Sign Out) -->
</div>
```

**Navigation Bar Features:**
- **Hamburger menu** - Toggle to show/hide navigation
- **Auto-hide on scroll** - Hides when scrolling down (after 100px)
- **Auto-show on scroll up** - Shows when scrolling up
- **Floating hamburger** - Appears when nav is hidden (top-left)
- **Home button** - Navigate to root
- **Back button** - Browser history back
- **Sign Out** - Logs out authenticated users

### Virtual Keyboard

Touch views automatically include a **web-based virtual keyboard** (defined in `touch.html.erb` layout):
- Shows on input focus (text, email, password, textarea)
- Integrated preview bar (shows what you're typing, left side of bottom row)
- Special character toggle button (@ → . → -)
- Enter key (green ↵, submits forms)
- Hide button (red, dismisses keyboard)
- Audio feedback on key press

**Keyboard is universal** - no need to add keyboard markup to individual views.

**For forms:** Add `pb-32` class to page container for extra bottom padding.

### Touch CSS Classes

Use these predefined classes from `touch.html.erb` layout:

| Class | Usage | Size |
|-------|-------|------|
| `touch-btn` | Base button | 80px height |
| `touch-btn-primary` | Primary action | Red gradient |
| `touch-btn-secondary` | Secondary action | Blue gradient |
| `touch-btn-icon` | Icon-only button | 64×64px |
| `touch-input` | Form input | 70px height, 1.25rem font |
| `touch-label` | Form label | 1.25rem font, bold |
| `touch-spacing` | Page padding | 2rem |
| `touch-logo` | Logo container | 120×120px |

### When Creating New Touch Views

1. **Set page title** with `<% content_for :page_title, "Title" %>`
2. **Use flexbox layout** on home page to prevent footer overlap
3. **Use large touch targets** (touch-btn classes, 64px for nav, 56px+ for content)
4. **Add bottom padding** for forms (`pb-32` class for keyboard clearance)
5. **Test on 800×480** (or with `?touch=1` on desktop)
6. **NO desktop toggle links** (users are already in touch mode)
7. **Ensure keyboard works** (test all input fields, verify Hide button)
8. **Test navigation** (Home, Back, hamburger menu collapse/expand)

### Documentation

Full touch display UX details: `docs/VIRTUAL_KEYBOARD.md`

---

These rules override default AI behavior.