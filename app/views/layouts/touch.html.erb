<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "ISMF Race Logger" %></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ISMF Race Logger">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Poppins font from Google Fonts %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <%# Enable PWA manifest for installable apps %>
    <%= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <style>
      /* Touch-optimized styles for 800x480 displays */
      body {
        font-family: 'Poppins', system-ui, sans-serif;
        font-size: 18px;
        overflow-x: hidden;
      }
      
      /* Disable text selection for touch interface */
      * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(233, 69, 96, 0.3);
      }
      
      input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      
      /* Large touch-friendly buttons */
      .touch-btn {
        min-height: 80px;
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1.5rem 2rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        transition: all 0.15s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .touch-btn:active {
        transform: scale(0.96);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      
      .touch-btn-primary {
        background: linear-gradient(135deg, #e94560 0%, #c73850 100%);
        color: white;
      }
      
      .touch-btn-secondary {
        background: linear-gradient(135deg, #0f3460 0%, #082441 100%);
        color: white;
      }
      
      /* Extra large logo */
      .touch-logo {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #e94560 0%, #c73850 100%);
        border-radius: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(233, 69, 96, 0.4);
      }
      
      .touch-logo svg {
        width: 72px;
        height: 72px;
      }
      
      /* Large form inputs */
      .touch-input {
        min-height: 70px;
        font-size: 1.25rem;
        padding: 1.25rem 1.5rem;
        border: 3px solid #d1d5db;
        border-radius: 1rem;
        width: 100%;
      }
      
      .touch-input:focus {
        outline: none;
        border-color: #0f3460;
        box-shadow: 0 0 0 4px rgba(15, 52, 96, 0.2);
      }
      
      .touch-label {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 0.75rem;
        display: block;
      }
      
      /* Large flash messages */
      .touch-flash {
        padding: 1.5rem 2rem;
        font-size: 1.25rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .touch-flash svg {
        width: 2rem;
        height: 2rem;
        flex-shrink: 0;
      }
      
      .touch-flash-notice {
        background-color: #f0fdf4;
        color: #166534;
        border: 2px solid #bbf7d0;
      }
      
      .touch-flash-alert {
        background-color: #fef2f2;
        color: #991b1b;
        border: 2px solid #fecaca;
      }
      
      /* Touch-friendly spacing */
      .touch-spacing {
        padding: 2rem;
      }
      
      .touch-spacing-lg {
        padding: 3rem;
      }
      
      /* Haptic feedback animation */
      @keyframes touch-ripple {
        0% {
          transform: scale(0.9);
          opacity: 0.8;
        }
        100% {
          transform: scale(1.1);
          opacity: 0;
        }
      }
      
      .touch-btn:active::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: inherit;
        animation: touch-ripple 0.4s ease-out;
      }
      
      .touch-btn {
        position: relative;
        overflow: hidden;
      }
      
      /* Hide scrollbars but keep functionality */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      
      ::-webkit-scrollbar-thumb {
        background: rgba(26, 26, 46, 0.3);
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(26, 26, 46, 0.5);
      }
      
      /* Debug info badge */
      .debug-info {
        position: fixed;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.7);
        color: #10b981;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-family: monospace;
        z-index: 9999;
      }
      
      /* Touch Navigation Bar */
      .touch-nav-btn {
        width: 64px;
        height: 64px;
        border-radius: 0.875rem;
        background: rgba(233, 69, 96, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.15s ease;
        border: 2px solid rgba(233, 69, 96, 0.3);
        flex-shrink: 0;
      }
      
      .touch-nav-btn:active {
        transform: scale(0.95);
        background: rgba(233, 69, 96, 0.3);
        border-color: rgba(233, 69, 96, 0.5);
      }
      
      .touch-nav-btn:hover {
        background: rgba(233, 69, 96, 0.25);
      }
      
      /* Navigation bar collapsed state */
      .nav-hidden {
        transform: translateY(-100%);
      }
    </style>
    
    <script>
      // Audio feedback for touch interactions
      document.addEventListener('DOMContentLoaded', function() {
        // Create audio context for haptic feedback sounds
        let audioContext;
        
        function playTouchSound() {
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
          
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Add touch sound to all buttons
        document.addEventListener('touchstart', function(e) {
          if (e.target.closest('.touch-btn, .btn, .btn-primary, .btn-secondary')) {
            playTouchSound();
          }
        }, { passive: true });
        
        // Create floating hamburger button
        const createFloatingHamburger = () => {
          const floatingBtn = document.createElement('button');
          floatingBtn.id = 'floating-hamburger';
          floatingBtn.className = 'fixed top-4 left-4 z-50 touch-nav-btn shadow-2xl';
          floatingBtn.style.display = 'none';
          floatingBtn.title = 'Show Menu';
          floatingBtn.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
          document.body.appendChild(floatingBtn);
          return floatingBtn;
        };
        
        // Hamburger menu toggle
        const navToggle = document.getElementById('nav-toggle');
        const navbar = document.getElementById('touch-navbar');
        const hamburgerIcon = document.getElementById('hamburger-icon');
        const closeIcon = document.getElementById('close-icon');
        const navSpacer = document.getElementById('nav-spacer');
        const floatingHamburger = navbar ? createFloatingHamburger() : null;
        let navVisible = true;
        let navCollapsed = false;
        
        if (navToggle && navbar && floatingHamburger) {
          // Toggle handler
          const toggleNav = (show) => {
            navCollapsed = !show;
            
            if (show) {
              navbar.classList.remove('nav-hidden');
              if (navSpacer) navSpacer.style.height = '84px';
              floatingHamburger.style.display = 'none';
            } else {
              navbar.classList.add('nav-hidden');
              if (navSpacer) navSpacer.style.height = '0';
              floatingHamburger.style.display = 'flex';
            }
          };
          
          // Hamburger icon toggle in navbar
          navToggle.addEventListener('click', function() {
            toggleNav(navCollapsed);
          });
          
          // Floating hamburger click handler
          floatingHamburger.addEventListener('click', function() {
            toggleNav(true);
          });
          
          // Auto-hide nav when scrolling down, show when scrolling up
          let lastScrollY = window.scrollY;
          let ticking = false;
          
          window.addEventListener('scroll', function() {
            if (!ticking) {
              window.requestAnimationFrame(function() {
                const currentScrollY = window.scrollY;
                
                if (currentScrollY > lastScrollY && currentScrollY > 100) {
                  // Scrolling down - auto-hide nav
                  if (!navCollapsed) {
                    toggleNav(false);
                  }
                } else if (currentScrollY < lastScrollY) {
                  // Scrolling up - auto-show nav
                  if (!navCollapsed) {
                    toggleNav(true);
                  }
                }
                
                lastScrollY = currentScrollY;
                ticking = false;
              });
              
              ticking = true;
            }
          }, { passive: true });
        }
        
        // Display detection info
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const devicePixelRatio = window.devicePixelRatio || 1;
        const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        
        console.log('Touch Display Detected:');
        console.log('- Screen:', screenWidth + 'x' + screenHeight);
        console.log('- Pixel Ratio:', devicePixelRatio);
        console.log('- Touch Support:', hasTouch);
        console.log('- User Agent:', navigator.userAgent);
        
        // Show debug info badge (remove in production)
        const debugInfo = document.createElement('div');
        debugInfo.className = 'debug-info';
        debugInfo.innerHTML = screenWidth + 'x' + screenHeight + ' • Touch: ' + (hasTouch ? 'Yes' : 'No');
        document.body.appendChild(debugInfo);
        
        // Auto-hide debug info after 5 seconds
        setTimeout(() => {
          debugInfo.style.opacity = '0';
          debugInfo.style.transition = 'opacity 1s';
          setTimeout(() => debugInfo.remove(), 1000);
        }, 5000);
      });
      
      // Virtual keyboard styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
        }
        
        .kbd-key {
          background: #34495e;
          color: white;
          border: 2px solid #4a5f7f;
          border-radius: 0.5rem;
          padding: 1rem;
          font-size: 1.5rem;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.1s;
          min-height: 56px;
          display: flex;
          align-items: center;
          justify-content: center;
          user-select: none;
          -webkit-user-select: none;
          -webkit-tap-highlight-color: rgba(233, 69, 96, 0.3);
        }
        .kbd-key:active {
          transform: scale(0.95);
          background: #e94560;
          box-shadow: 0 4px 8px rgba(0,0,0,0.3) inset;
        }
        .kbd-shift.active {
          background: #e94560;
        }
        
        /* Enhanced visibility for focused inputs */
        input:focus,
        textarea:focus {
          font-size: 1.5rem !important;
          background: #fff !important;
          border: 3px solid #e94560 !important;
          box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.3) !important;
        }
      `;
      document.head.appendChild(style);
    </script>
  </head>

  <body class="min-h-screen bg-gradient-to-br from-ismf-navy via-ismf-blue to-ismf-navy text-white antialiased">
    <!-- Collapsible Touch Navigation Bar -->
    <% unless request.path == root_path %>
      <nav id="touch-navbar" class="fixed top-0 left-0 right-0 z-40 bg-ismf-navy/95 backdrop-blur-sm border-b-2 border-ismf-red shadow-lg transition-transform duration-300">
        <div class="flex items-center justify-between px-6 py-4 gap-4">
          <!-- Hamburger Menu -->
          <button id="nav-toggle" class="touch-nav-btn" title="Toggle Menu">
            <svg id="hamburger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg id="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem; display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          
          <!-- Home Button -->
          <%= link_to root_path, class: "touch-nav-btn", title: "Home" do %>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          <% end %>
          
          <!-- Back Button (JavaScript controlled) -->
          <button onclick="window.history.back()" class="touch-nav-btn" title="Back">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </button>
          
          <!-- Page Title (centered) -->
          <div class="flex-1 text-center">
            <h1 class="text-xl font-bold text-white truncate px-2" id="touch-nav-title">
              <%= content_for?(:page_title) ? yield(:page_title) : "ISMF" %>
            </h1>
          </div>
          
          <!-- Sign Out Button (if authenticated) -->
          <% if Current.user %>
            <%= button_to session_path, method: :delete, class: "touch-nav-btn", title: "Sign Out" do %>
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            <% end %>
          <% else %>
            <!-- Placeholder to maintain layout balance -->
            <div class="w-16 h-16"></div>
          <% end %>
        </div>
      </nav>
      
      <!-- Spacer for fixed nav -->
      <div id="nav-spacer" style="height: 84px;"></div>
    <% end %>
    
    <% if notice %>
      <div class="touch-flash touch-flash-notice fixed top-20 left-4 right-4 z-50" data-controller="flash" data-flash-dismiss-after-value="5000">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= notice %></span>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="touch-flash touch-flash-alert fixed top-20 left-4 right-4 z-50" data-controller="flash" data-flash-dismiss-after-value="5000">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= alert %></span>
      </div>
    <% end %>

    <%= yield %>
    
    <!-- Universal Virtual Keyboard for Touch Displays -->
    <div id="virtual-keyboard" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; padding: 0.75rem; z-index: 9999; border-top: 3px solid #e94560; box-shadow: 0 -4px 20px rgba(0,0,0,0.5);">
      <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.4rem; margin-bottom: 0.4rem;">
        <button class="kbd-key" data-key="1">1</button>
        <button class="kbd-key" data-key="2">2</button>
        <button class="kbd-key" data-key="3">3</button>
        <button class="kbd-key" data-key="4">4</button>
        <button class="kbd-key" data-key="5">5</button>
        <button class="kbd-key" data-key="6">6</button>
        <button class="kbd-key" data-key="7">7</button>
        <button class="kbd-key" data-key="8">8</button>
        <button class="kbd-key" data-key="9">9</button>
        <button class="kbd-key" data-key="0">0</button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.4rem; margin-bottom: 0.4rem;">
        <button class="kbd-key" data-key="q">q</button>
        <button class="kbd-key" data-key="w">w</button>
        <button class="kbd-key" data-key="e">e</button>
        <button class="kbd-key" data-key="r">r</button>
        <button class="kbd-key" data-key="t">t</button>
        <button class="kbd-key" data-key="y">y</button>
        <button class="kbd-key" data-key="u">u</button>
        <button class="kbd-key" data-key="i">i</button>
        <button class="kbd-key" data-key="o">o</button>
        <button class="kbd-key" data-key="p">p</button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 0.4rem; margin-bottom: 0.4rem; padding-left: 1.5rem;">
        <button class="kbd-key" data-key="a">a</button>
        <button class="kbd-key" data-key="s">s</button>
        <button class="kbd-key" data-key="d">d</button>
        <button class="kbd-key" data-key="f">f</button>
        <button class="kbd-key" data-key="g">g</button>
        <button class="kbd-key" data-key="h">h</button>
        <button class="kbd-key" data-key="j">j</button>
        <button class="kbd-key" data-key="k">k</button>
        <button class="kbd-key" data-key="l">l</button>
      </div>
      <div style="display: grid; grid-template-columns: 1.5fr repeat(7, 1fr) 1fr; gap: 0.4rem; margin-bottom: 0.4rem;">
        <button class="kbd-key kbd-shift" data-key="shift">⇧</button>
        <button class="kbd-key" data-key="z">z</button>
        <button class="kbd-key" data-key="x">x</button>
        <button class="kbd-key" data-key="c">c</button>
        <button class="kbd-key" data-key="v">v</button>
        <button class="kbd-key" data-key="b">b</button>
        <button class="kbd-key" data-key="n">n</button>
        <button class="kbd-key" data-key="m">m</button>
        <button class="kbd-key" data-key="_">_</button>
      </div>
      <div style="display: grid; grid-template-columns: 3fr 1fr 2fr 1fr 1fr 1fr 1.5fr; gap: 0.4rem;">
        <div id="input-preview" style="background: #1a1a1a; color: #fff; border: 2px solid #4a5f7f; border-radius: 0.5rem; padding: 0.5rem 1rem; display: flex; align-items: center; overflow-x: auto; white-space: nowrap;">
          <span id="preview-text" style="font-family: monospace; font-size: 1.25rem; font-weight: 700; letter-spacing: 0.1em;"></span>
          <span id="cursor" style="animation: blink 1s infinite; margin-left: 0.25rem; font-weight: 300;">|</span>
        </div>
        <button class="kbd-key kbd-special" data-key="@">@</button>
        <button class="kbd-key kbd-space" data-key="space">space</button>
        <button class="kbd-key" data-key=",">,</button>
        <button class="kbd-key kbd-backspace" data-key="backspace">⌫</button>
        <button class="kbd-key kbd-enter" data-key="enter" style="background: #16a34a; font-weight: 700;">↵</button>
        <button class="kbd-key kbd-hide" style="background: #e94560; font-weight: 700;">Hide</button>
      </div>
    </div>
    
    <style>
      .kbd-key {
        background: #34495e;
        color: white;
        border: 2px solid #4a5f7f;
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.1s;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: rgba(233, 69, 96, 0.3);
      }
      .kbd-key:active {
        transform: scale(0.95);
        background: #e94560;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3) inset;
      }
      .kbd-shift.active {
        background: #e94560;
      }
    </style>
    
    <script>
      // Virtual Keyboard - Turbo-safe implementation
      (function() {
        'use strict';
        
        // Guard against multiple initializations
        if (window.virtualKeyboardInitialized) {
          return;
        }
        window.virtualKeyboardInitialized = true;
        
        let activeInput = null;
        let isShiftActive = false;
        let specialChars = ['@', '.', '-'];
        let specialCharIndex = 0;
        let audioContext = null;
        let isProcessingKey = false;
        
        const keyboard = document.getElementById('virtual-keyboard');
        if (!keyboard) return;
        
        const previewText = document.getElementById('preview-text');
        let keyboardHeight = 0;
        
        // Initialize audio context on first use
        function initAudio() {
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }
        }
        
        // Play key press sound
        function playKeySound() {
          initAudio();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 800;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.05);
        }
        
        // Update preview display
        function updatePreview() {
          if (!activeInput) {
            previewText.textContent = '';
            return;
          }
          
          const value = activeInput.value;
          
          if (activeInput.type === 'password') {
            previewText.textContent = value ? '•'.repeat(value.length) : '';
          } else {
            previewText.textContent = value || '';
          }
          
          // Auto-scroll preview to show end of text
          const previewContainer = document.getElementById('input-preview');
          if (previewContainer) {
            previewContainer.scrollLeft = previewContainer.scrollWidth;
          }
        }
        
        // Position keyboard using Visual Viewport API
        function updateKeyboardPosition() {
          if (keyboard.style.display !== 'none') {
            const visualViewport = window.visualViewport;
            if (visualViewport) {
              keyboard.style.bottom = '0px';
              keyboard.style.left = visualViewport.offsetLeft + 'px';
              keyboard.style.width = visualViewport.width + 'px';
            }
          }
        }
        
        // Scroll input into view above keyboard
        function scrollInputIntoView(input) {
          setTimeout(() => {
            const inputRect = input.getBoundingClientRect();
            const visualViewport = window.visualViewport || window;
            const availableHeight = visualViewport.height - keyboardHeight;
            
            if (inputRect.bottom > availableHeight - 20) {
              const scrollAmount = inputRect.bottom - (availableHeight - 40);
              window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
            }
          }, 100);
        }
        
        // Show keyboard when input is focused
        document.addEventListener('focusin', function(e) {
          if (e.target.matches('input[type="text"], input[type="email"], input[type="password"], textarea')) {
            activeInput = e.target;
            keyboard.style.display = 'block';
            
            // Get keyboard height and position
            setTimeout(() => {
              keyboardHeight = keyboard.offsetHeight;
              updateKeyboardPosition();
              scrollInputIntoView(e.target);
            }, 50);
            
            updatePreview();
          }
        }, true);
        
        // CRITICAL: Prevent native keyboard on touch devices
        let preventNativeKeyboard = function(e) {
          if (e.target.matches('input[type="text"], input[type="email"], input[type="password"], textarea')) {
            // Don't preventDefault on keyboard buttons
            if (e.target.closest('#virtual-keyboard')) {
              return;
            }
            e.target.setAttribute('readonly', 'readonly');
            setTimeout(() => {
              e.target.removeAttribute('readonly');
              e.target.focus();
            }, 100);
          }
        };
        document.addEventListener('touchstart', preventNativeKeyboard, { passive: false });
        
        // Update preview when input value changes externally (but not from our keyboard)
        let handleInputChange = function(e) {
          if (!isProcessingKey && e.target === activeInput) {
            updatePreview();
          }
        };
        document.addEventListener('input', handleInputChange, true);
        
        // Handle viewport changes
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', updateKeyboardPosition);
          window.visualViewport.addEventListener('scroll', updateKeyboardPosition);
        }
        
        // Handle keyboard button presses
        let handleKeyPress = function(e) {
          e.preventDefault(); // Prevent focus loss and double events
          e.stopPropagation();
          
          const key = e.target.closest('.kbd-key');
          if (!key) return;
          
          // Prevent double-tap issues
          if (isProcessingKey) return;
          
          isProcessingKey = true;
          playKeySound();
          
          const keyValue = key.dataset.key;
          
          // Hide keyboard
          if (key.classList.contains('kbd-hide')) {
            keyboard.style.display = 'none';
            if (activeInput) {
              activeInput.blur();
              activeInput = null;
            }
            previewText.textContent = '';
            isProcessingKey = false;
            return;
          }
          
          if (!activeInput) {
            isProcessingKey = false;
            return;
          }
          
          // Special character cycling button
          if (key.classList.contains('kbd-special')) {
            specialCharIndex = (specialCharIndex + 1) % specialChars.length;
            const newChar = specialChars[specialCharIndex];
            key.textContent = newChar;
            key.dataset.key = newChar;
            isProcessingKey = false;
            return;
          }
          
          // Shift key
          if (keyValue === 'shift') {
            isShiftActive = !isShiftActive;
            key.classList.toggle('active', isShiftActive);
            isProcessingKey = false;
            return;
          }
          
          // Get current cursor position (or end of text)
          const start = activeInput.selectionStart || activeInput.value.length;
          const end = activeInput.selectionEnd || activeInput.value.length;
          const currentValue = activeInput.value;
          
          let newValue = currentValue;
          let newCursorPos = start;
          
          // Enter key
          if (keyValue === 'enter') {
            if (activeInput.tagName === 'TEXTAREA') {
              newValue = currentValue.slice(0, start) + '\n' + currentValue.slice(end);
              newCursorPos = start + 1;
            } else {
              // Submit form
              const form = activeInput.closest('form');
              if (form) {
                isProcessingKey = false;
                form.requestSubmit();
                return;
              }
            }
          }
          // Backspace
          else if (keyValue === 'backspace') {
            if (start > 0) {
              newValue = currentValue.slice(0, start - 1) + currentValue.slice(end);
              newCursorPos = start - 1;
            }
          }
          // Space
          else if (keyValue === 'space') {
            newValue = currentValue.slice(0, start) + ' ' + currentValue.slice(end);
            newCursorPos = start + 1;
          }
          // Regular character
          else {
            let char = keyValue;
            
            // Apply shift if active
            if (isShiftActive && char.length === 1 && char.match(/[a-z]/)) {
              char = char.toUpperCase();
              isShiftActive = false;
              document.querySelector('.kbd-shift').classList.remove('active');
            }
            
            newValue = currentValue.slice(0, start) + char + currentValue.slice(end);
            newCursorPos = start + char.length;
          }
          
          // Update input value and cursor position
          activeInput.value = newValue;
          activeInput.setSelectionRange(newCursorPos, newCursorPos);
          
          // Update preview immediately
          updatePreview();
          
          // Trigger input event for validation/listeners
          activeInput.dispatchEvent(new Event('input', { bubbles: true }));
          
          // Reset processing flag after a short delay to prevent rapid double-taps
          setTimeout(() => {
            isProcessingKey = false;
          }, 100);
        };
        
        keyboard.addEventListener('touchstart', handleKeyPress, { passive: false });
        
        // Fallback for click events (desktop testing)
        keyboard.addEventListener('click', handleKeyPress, { passive: false });
        
        // Cleanup on Turbo navigation
        document.addEventListener('turbo:before-render', function() {
          if (keyboard && keyboard.style.display !== 'none') {
            keyboard.style.display = 'none';
          }
          if (activeInput) {
            activeInput.blur();
            activeInput = null;
          }
        });
        
        // Reset on page restore (back button)
        document.addEventListener('turbo:load', function() {
          if (keyboard) {
            keyboard.style.display = 'none';
          }
          activeInput = null;
          isShiftActive = false;
          specialCharIndex = 0;
          
          // Reset special char button
          const specialBtn = keyboard.querySelector('.kbd-special');
          if (specialBtn) {
            specialBtn.textContent = '@';
            specialBtn.dataset.key = '@';
          }
          
          // Reset shift button
          const shiftBtn = keyboard.querySelector('.kbd-shift');
          if (shiftBtn) {
            shiftBtn.classList.remove('active');
          }
        });
      })();
    </script>
  </body>
</html>
