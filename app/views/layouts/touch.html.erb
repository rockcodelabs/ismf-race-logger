<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for(:title) || "ISMF Race Logger" %></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ISMF Race Logger">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Poppins font from Google Fonts %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <%# Enable PWA manifest for installable apps %>
    <%= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <style>
      /* Touch-optimized base styles */
      body {
        font-family: 'Poppins', system-ui, sans-serif;
        font-size: 18px;
        overflow-x: hidden;
      }
      
      /* Disable text selection except for inputs */
      * {
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(233, 69, 96, 0.3);
      }
      
      input, textarea {
        -webkit-user-select: text;
        -moz-user-select: text;
        user-select: text;
      }
      
      /* Touch button styles */
      .touch-btn {
        min-height: 80px;
        font-size: 1.5rem;
        font-weight: 700;
        padding: 1.5rem 2rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        transition: all 0.15s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
        overflow: hidden;
      }
      
      .touch-btn:active {
        transform: scale(0.96);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      
      .touch-btn-primary {
        background: linear-gradient(135deg, #e94560 0%, #c73850 100%);
        color: white;
      }
      
      .touch-btn-secondary {
        background: linear-gradient(135deg, #0f3460 0%, #082441 100%);
        color: white;
      }
      
      /* Touch logo */
      .touch-logo {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #e94560 0%, #c73850 100%);
        border-radius: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(233, 69, 96, 0.4);
      }
      
      .touch-logo svg {
        width: 72px;
        height: 72px;
      }
      
      /* Touch form inputs */
      .touch-input {
        min-height: 70px;
        font-size: 1.25rem;
        padding: 1.25rem 1.5rem;
        border: 3px solid #d1d5db;
        border-radius: 1rem;
        width: 100%;
      }
      
      .touch-input:focus {
        outline: none;
        border-color: #e94560;
        box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.2);
      }
      
      .touch-label {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 0.75rem;
        display: block;
      }
      
      /* Touch flash messages */
      .touch-flash {
        padding: 1.5rem 2rem;
        font-size: 1.25rem;
        border-radius: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .touch-flash svg {
        width: 2rem;
        height: 2rem;
        flex-shrink: 0;
      }
      
      .touch-flash-notice {
        background-color: #f0fdf4;
        color: #166534;
        border: 2px solid #bbf7d0;
      }
      
      .touch-flash-alert {
        background-color: #fef2f2;
        color: #991b1b;
        border: 2px solid #fecaca;
      }
      
      /* Touch spacing utilities */
      .touch-spacing {
        padding: 2rem;
      }
      
      .touch-spacing-lg {
        padding: 3rem;
      }
      
      /* Navigation button styles */
      .touch-nav-btn {
        width: 64px;
        height: 64px;
        border-radius: 0.875rem;
        background: rgba(233, 69, 96, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.15s ease;
        border: 2px solid rgba(233, 69, 96, 0.3);
        flex-shrink: 0;
      }
      
      .touch-nav-btn:active {
        transform: scale(0.95);
        background: rgba(233, 69, 96, 0.3);
        border-color: rgba(233, 69, 96, 0.5);
      }
      
      .nav-hidden {
        transform: translateY(-100%);
      }
      
      /* Hide scrollbars but keep functionality */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      
      ::-webkit-scrollbar-thumb {
        background: rgba(26, 26, 46, 0.3);
        border-radius: 4px;
      }
      
      /* ========================================
         VIRTUAL KEYBOARD STYLES
         ======================================== */
      
      #virtual-keyboard {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #2c3e50;
        padding: 1rem;
        z-index: 10000;
        border-top: 4px solid #e94560;
        box-shadow: 0 -6px 24px rgba(0, 0, 0, 0.6);
        display: none;
      }
      
      /* Preview display */
      #kbd-preview {
        background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
        border: 3px solid #10b981;
        border-radius: 0.75rem;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        min-height: 80px;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
      }
      
      #kbd-preview-label {
        font-size: 0.875rem;
        color: #10b981;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 0.5rem;
        opacity: 0.9;
      }
      
      #kbd-preview-content {
        display: flex;
        align-items: center;
        min-height: 36px;
      }
      
      #kbd-preview-text {
        font-family: monospace;
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: 0.05em;
        flex: 1;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      #kbd-cursor {
        font-size: 2rem;
        color: #10b981;
        font-weight: 300;
        margin-left: 0.5rem;
        animation: kbd-blink 1s infinite;
      }
      
      @keyframes kbd-blink {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0; }
      }
      
      /* Keyboard keys */
      .kbd-key {
        background: #34495e;
        color: white;
        border: 2px solid #4a5f7f;
        border-radius: 0.5rem;
        padding: 1rem;
        font-size: 1.25rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.1s ease;
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }
      
      .kbd-key:active {
        transform: scale(0.95);
        background: #4a5f7f;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3) inset;
      }
      
      .kbd-shift.active {
        background: #e94560;
        border-color: #fff;
      }
      
      .kbd-backspace {
        background: #e67e22 !important;
      }
      
      .kbd-backspace:active {
        background: #d35400 !important;
      }
      
      .kbd-enter {
        background: #16a34a !important;
        font-size: 1rem !important;
      }
      
      .kbd-enter:active {
        background: #15803d !important;
      }
      
      .kbd-hide {
        background: #e94560 !important;
        font-size: 1rem !important;
      }
      
      .kbd-hide:active {
        background: #c73850 !important;
      }
      
      .kbd-space {
        font-size: 1rem;
      }
    </style>
  </head>

  <body class="min-h-screen bg-gradient-to-br from-ismf-navy via-ismf-blue to-ismf-navy text-white antialiased">
    
    <!-- Collapsible Touch Navigation Bar (not shown on home page) -->
    <% unless request.path == root_path %>
      <nav id="touch-navbar" class="fixed top-0 left-0 right-0 z-40 bg-ismf-navy/95 backdrop-blur-sm border-b-2 border-ismf-red shadow-lg transition-transform duration-300">
        <div class="flex items-center justify-between px-6 py-4 gap-4">
          <!-- Hamburger Menu -->
          <button id="nav-toggle" class="touch-nav-btn" title="Toggle Menu">
            <svg id="hamburger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          
          <!-- Home Button -->
          <%= link_to root_path, class: "touch-nav-btn", title: "Home" do %>
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          <% end %>
          
          <!-- Back Button -->
          <button onclick="window.history.back()" class="touch-nav-btn" title="Back">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </button>
          
          <!-- Page Title -->
          <div class="flex-1 text-center">
            <h1 class="text-xl font-bold text-white truncate px-2">
              <%= content_for?(:page_title) ? yield(:page_title) : "ISMF" %>
            </h1>
          </div>
          
          <!-- Sign Out Button -->
          <% if Current.user %>
            <%= button_to session_path, method: :delete, class: "touch-nav-btn", title: "Sign Out" do %>
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            <% end %>
          <% else %>
            <div class="w-16 h-16"></div>
          <% end %>
        </div>
      </nav>
      
      <!-- Spacer for fixed nav -->
      <div id="nav-spacer" style="height: 84px;"></div>
    <% end %>
    
    <!-- Flash Messages -->
    <% if notice %>
      <div class="touch-flash touch-flash-notice fixed top-20 left-4 right-4 z-50" data-controller="flash" data-flash-dismiss-after-value="5000">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= notice %></span>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="touch-flash touch-flash-alert fixed top-20 left-4 right-4 z-50" data-controller="flash" data-flash-dismiss-after-value="5000">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span><%= alert %></span>
      </div>
    <% end %>

    <%= yield %>
    
    <%= render 'shared/virtual_keyboard' %>
  </body>
</html>