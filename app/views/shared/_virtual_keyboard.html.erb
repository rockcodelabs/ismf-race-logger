<!-- ========================================
     VIRTUAL KEYBOARD PARTIAL
     ======================================== -->

<div id="virtual-keyboard" style="display: block !important;">
  
  <!-- Preview Display -->
  <div id="kbd-preview">
    <div id="kbd-preview-label">You are typing:</div>
    <div id="kbd-preview-content">
      <div id="kbd-preview-text">Tap an input field to start...</div>
      <div id="kbd-cursor">|</div>
    </div>
  </div>
  
  <!-- Row 1: Numbers -->
  <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
    <button class="kbd-key" data-char="1">1</button>
    <button class="kbd-key" data-char="2">2</button>
    <button class="kbd-key" data-char="3">3</button>
    <button class="kbd-key" data-char="4">4</button>
    <button class="kbd-key" data-char="5">5</button>
    <button class="kbd-key" data-char="6">6</button>
    <button class="kbd-key" data-char="7">7</button>
    <button class="kbd-key" data-char="8">8</button>
    <button class="kbd-key" data-char="9">9</button>
    <button class="kbd-key" data-char="0">0</button>
  </div>
  
  <!-- Row 2: QWERTY -->
  <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 0.5rem; margin-bottom: 0.5rem;">
    <button class="kbd-key" data-char="q">q</button>
    <button class="kbd-key" data-char="w">w</button>
    <button class="kbd-key" data-char="e">e</button>
    <button class="kbd-key" data-char="r">r</button>
    <button class="kbd-key" data-char="t">t</button>
    <button class="kbd-key" data-char="y">y</button>
    <button class="kbd-key" data-char="u">u</button>
    <button class="kbd-key" data-char="i">i</button>
    <button class="kbd-key" data-char="o">o</button>
    <button class="kbd-key" data-char="p">p</button>
  </div>
  
  <!-- Row 3: ASDFGH -->
  <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 0.5rem; margin-bottom: 0.5rem; padding: 0 1.5rem;">
    <button class="kbd-key" data-char="a">a</button>
    <button class="kbd-key" data-char="s">s</button>
    <button class="kbd-key" data-char="d">d</button>
    <button class="kbd-key" data-char="f">f</button>
    <button class="kbd-key" data-char="g">g</button>
    <button class="kbd-key" data-char="h">h</button>
    <button class="kbd-key" data-char="j">j</button>
    <button class="kbd-key" data-char="k">k</button>
    <button class="kbd-key" data-char="l">l</button>
  </div>
  
  <!-- Row 4: ZXCVBN with Shift -->
  <div style="display: grid; grid-template-columns: 1.5fr repeat(7, 1fr) 1.5fr; gap: 0.5rem; margin-bottom: 0.5rem;">
    <button class="kbd-key kbd-shift" data-action="shift">‚áß Shift</button>
    <button class="kbd-key" data-char="z">z</button>
    <button class="kbd-key" data-char="x">x</button>
    <button class="kbd-key" data-char="c">c</button>
    <button class="kbd-key" data-char="v">v</button>
    <button class="kbd-key" data-char="b">b</button>
    <button class="kbd-key" data-char="n">n</button>
    <button class="kbd-key" data-char="m">m</button>
    <button class="kbd-key kbd-backspace" data-action="backspace">‚å´ DEL</button>
  </div>
  
  <!-- Row 5: Special characters and actions -->
  <div style="display: grid; grid-template-columns: 1fr 1fr 3fr 1fr 1.5fr 1.5fr; gap: 0.5rem;">
    <button class="kbd-key" data-char="@">@</button>
    <button class="kbd-key" data-char=".">.</button>
    <button class="kbd-key kbd-space" data-char=" ">SPACE</button>
    <button class="kbd-key" data-char="_">_</button>
    <button class="kbd-key kbd-enter" data-action="enter">‚Üµ ENTER</button>
    <button class="kbd-key kbd-hide" data-action="hide">‚úï HIDE</button>
  </div>
  
</div>

<script>
  // ========================================
  // VIRTUAL KEYBOARD - Clean Implementation
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üéπ DOM Ready - Initializing virtual keyboard...');
    
    // Prevent multiple initializations
    if (window.KEYBOARD_INITIALIZED) {
      console.log('‚ö†Ô∏è Keyboard already initialized');
      return;
    }
    window.KEYBOARD_INITIALIZED = true;
    
    // State
    let activeInput = null;
    let shiftActive = false;
    
    // DOM Elements
    const keyboard = document.getElementById('virtual-keyboard');
    const preview = document.getElementById('kbd-preview');
    const previewText = document.getElementById('kbd-preview-text');
    const shiftBtn = document.querySelector('.kbd-shift');
    
    if (!keyboard || !previewText) {
      console.error('‚ùå Keyboard elements not found');
      return;
    }
    
    console.log('‚úÖ Keyboard elements ready');
    
    // ========================================
    // AUDIO FEEDBACK
    // ========================================
    let audioCtx = null;
    
    function playBeep() {
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        osc.frequency.value = 800;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.06);
        
        osc.start();
        osc.stop(audioCtx.currentTime + 0.06);
      } catch (e) {
        // Silently fail if audio not available
      }
    }
    
    // ========================================
    // UPDATE PREVIEW DISPLAY
    // ========================================
    function updatePreview() {
      if (!activeInput) {
        previewText.textContent = 'Tap an input field to start...';
        previewText.style.opacity = '0.5';
        previewText.style.fontStyle = 'italic';
        previewText.style.color = '#888';
        return;
      }
      
      const value = activeInput.value;
      
      if (value && value.length > 0) {
        previewText.style.opacity = '1';
        previewText.style.fontStyle = 'normal';
        previewText.style.color = '#fff';
        
        // Show bullets for password, actual text for others
        if (activeInput.type === 'password') {
          previewText.textContent = '‚Ä¢'.repeat(value.length);
        } else {
          previewText.textContent = value;
        }
        
        // Scroll to end
        setTimeout(() => {
          const container = preview;
          if (container) {
            container.scrollLeft = container.scrollWidth;
          }
        }, 10);
      } else {
        // Empty - show placeholder
        previewText.style.opacity = '0.6';
        previewText.style.fontStyle = 'italic';
        previewText.style.color = '#888';
        
        const placeholder = activeInput.placeholder || 
                          (activeInput.type === 'email' ? 'your@email.com' : 
                           activeInput.type === 'password' ? 'password' : 
                           'start typing...');
        previewText.textContent = placeholder;
      }
    }
    
    // ========================================
    // SHOW/HIDE KEYBOARD
    // ========================================
    function showKeyboard(input) {
      activeInput = input;
      keyboard.style.display = 'block';
      updatePreview();
      
      console.log('‚å®Ô∏è Keyboard shown for:', input.id || input.name);
      
      // Scroll input into view (above keyboard)
      setTimeout(() => {
        const inputRect = input.getBoundingClientRect();
        const kbdHeight = keyboard.offsetHeight;
        const availableHeight = window.innerHeight - kbdHeight;
        
        if (inputRect.bottom > availableHeight - 20) {
          const scrollNeeded = inputRect.bottom - (availableHeight - 40);
          window.scrollBy({ top: scrollNeeded, behavior: 'smooth' });
        }
      }, 100);
    }
    
    function hideKeyboard() {
      keyboard.style.display = 'none';
      if (activeInput) {
        activeInput.blur();
      }
      activeInput = null;
      shiftActive = false;
      if (shiftBtn) shiftBtn.classList.remove('active');
      updatePreview();
      
      console.log('üö´ Keyboard hidden');
    }
    
    // ========================================
    // INPUT FIELD FOCUS HANDLING
    // ========================================
    document.addEventListener('focusin', function(e) {
      const target = e.target;
      console.log('üîç FOCUSIN EVENT - target:', target.tagName, target.type, target.id);
      
      // Only show keyboard for text-like inputs
      if (target.matches('input[type="text"], input[type="email"], input[type="password"], textarea')) {
        console.log('‚úÖ Input matched! ID:', target.id || target.name);
        showKeyboard(target);
      } else {
        console.log('‚ùå Input did NOT match selector');
      }
    }, true);
    
    // Prevent native mobile keyboard from appearing
    document.addEventListener('touchstart', function(e) {
      const target = e.target;
      
      if (target.matches('input[type="text"], input[type="email"], input[type="password"], textarea')) {
        // Skip if it's inside the virtual keyboard
        if (target.closest('#virtual-keyboard')) {
          console.log('‚è≠Ô∏è Skipping - target is inside keyboard');
          return;
        }
        
        console.log('üõ°Ô∏è Preventing native keyboard for:', target.id);
        target.readOnly = true;
        setTimeout(() => {
          target.readOnly = false;
          target.focus();
          console.log('‚úÖ Input re-focused after readonly trick');
        }, 100);
      }
    }, { passive: false });
    
    // ========================================
    // KEYBOARD KEY PRESS HANDLING
    // ========================================
    function handleKeyPress(e) {
      console.log('üñ±Ô∏è handleKeyPress called - event:', e.type, 'target:', e.target.tagName);
      
      const btn = e.target.closest('.kbd-key');
      if (!btn) {
        console.log('‚ùå No kbd-key button found');
        return;
      }
      
      console.log('‚úÖ Button found:', btn.textContent);
      
      e.preventDefault();
      e.stopPropagation();
      
      playBeep();
      
      // Get the character or action
      const char = btn.dataset.char;
      const action = btn.dataset.action;
      
      console.log('üîë Key pressed - char:', char, 'action:', action);
      console.log('üìç Current activeInput:', activeInput ? (activeInput.id || activeInput.name) : 'NULL');
      
      // Handle actions
      if (action) {
        if (action === 'hide') {
          hideKeyboard();
          return;
        }
        
        if (action === 'shift') {
          shiftActive = !shiftActive;
          btn.classList.toggle('active', shiftActive);
          console.log('‚áß Shift:', shiftActive);
          return;
        }
        
        if (action === 'backspace') {
          if (!activeInput) return;
          const val = activeInput.value;
          activeInput.value = val.slice(0, -1);
          activeInput.dispatchEvent(new Event('input', { bubbles: true }));
          updatePreview();
          console.log('‚å´ Backspace. New value:', activeInput.value);
          return;
        }
        
        if (action === 'enter') {
          if (!activeInput) return;
          
          if (activeInput.tagName === 'TEXTAREA') {
            // Add newline in textarea
            activeInput.value += '\n';
            activeInput.dispatchEvent(new Event('input', { bubbles: true }));
            updatePreview();
          } else {
            // Submit form
            const form = activeInput.closest('form');
            if (form) {
              console.log('üì§ Submitting form');
              form.requestSubmit();
            }
          }
          return;
        }
      }
      
      // Handle regular character input
      if (char) {
        console.log('üìù Handling character:', char);
        
        if (!activeInput) {
          console.error('‚ùå ERROR: activeInput is NULL! Cannot add character.');
          return;
        }
        
        console.log('‚úÖ activeInput exists:', activeInput.id || activeInput.name, 'Current value:', activeInput.value);
        
        let character = char;
        
        // Apply shift for letters
        if (shiftActive && char.match(/^[a-z]$/)) {
          character = char.toUpperCase();
          shiftActive = false;
          if (shiftBtn) shiftBtn.classList.remove('active');
          console.log('‚áß Applied shift - character is now:', character);
        }
        
        // Add character to input
        const oldValue = activeInput.value;
        activeInput.value += character;
        console.log('üìù Value changed from:', oldValue, 'to:', activeInput.value);
        
        activeInput.dispatchEvent(new Event('input', { bubbles: true }));
        updatePreview();
        
        console.log('‚úÖ Character added successfully!');
      }
    }
    
    // Listen for both touch and click
    keyboard.addEventListener('touchstart', handleKeyPress, { passive: false });
    keyboard.addEventListener('click', handleKeyPress, { passive: false });
    
    // ========================================
    // CLEANUP ON TURBO NAVIGATION
    // ========================================
    document.addEventListener('turbo:before-visit', function() {
      hideKeyboard();
    });
    
    console.log('‚úÖ Virtual keyboard ready');
  });
</script>